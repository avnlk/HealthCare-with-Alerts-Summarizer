---
# Backend Role - Renders templates and deploys healthcare services to Kubernetes

- name: Create a temporary directory for rendered manifests
  ansible.builtin.tempfile:
    state: directory
    suffix: k8s-manifests
  register: temp_manifest_dir
  changed_when: false

- name: Find all k8s template files
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/../../kubernetes/"
    patterns: "*.yaml.j2"
    recurse: yes
  register: k8s_templates
  changed_when: false

- name: "Render Kubernetes templates"
  ansible.builtin.template:
    src: "{{ item.path }}"
    dest: "{{ temp_manifest_dir.path }}/{{ item.path | basename | regex_replace('\\.j2$', '') }}"
  loop: "{{ k8s_templates.files }}"
  loop_control:
    label: "{{ item.path | basename }}"
  changed_when: false

- name: Apply all rendered Kubernetes manifests from the temporary directory
  ansible.builtin.command: kubectl apply -f {{ temp_manifest_dir.path }}/
  register: kubectl_apply_result
  changed_when: "'configured' in kubectl_apply_result.stdout or 'created' in kubectl_apply_result.stdout"

- name: Print kubectl apply results for debugging
  ansible.builtin.debug:
    var: kubectl_apply_result.stdout_lines

- name: Wait for deployments to be ready
  ansible.builtin.command: kubectl rollout status deployment/{{ item }} -n healthcare --timeout=300s
  loop:
    - vitals-generator
    - alert-engine
    - summarizer-service
    - frontend
  changed_when: false

- name: Cleanup temporary directory
  ansible.builtin.file:
    path: "{{ temp_manifest_dir.path }}"
    state: absent
  when: temp_manifest_dir.path is defined
  changed_when: false
