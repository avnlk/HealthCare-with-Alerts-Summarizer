
pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = "docker.io"
        DOCKER_USERNAME = "avnlk"
        DOCKER_CREDENTIALS_ID = "dockerhub-cred"
        APP_VERSION = "1.0.${env.BUILD_NUMBER}"
    }

    stages {
        stage('1. Checkout') {
            steps {
                script{
                    checkout scm
                }
            }
        }

        stage('2. Backend Unit Tests') {
            parallel {
                stage('Alert Engine Tests') {
                    steps {
                        dir('backend/alert-engine') {
                            sh 'docker run --rm -v $PWD:/app -w /app python:3.11-slim sh -c "pip install -r requirements.txt && pip install pytest && python -m pytest tests/ -v"'
                        }
                    }
                }
                // stage('Summarizer Service Tests') {
                //     steps {
                //         dir('backend/summarizer-service') {
                //             sh 'docker run --rm -v $PWD:/app -w /app python:3.11-slim sh -c "pip install -r requirements.txt && pip install pytest && python -m pytest tests/ -v"'
                //         }
                //     }
                // }
                stage('Vitals Generator Tests') {
                    steps {
                        dir('backend/vitals-generator') {
                            sh 'docker run --rm -v $PWD:/app -w /app python:3.11-slim sh -c "pip install -r requirements.txt && pip install pytest && python -m pytest tests/ -v"'
                        }
                    }
                }
            }
        }

        // stage('3. Frontend Unit Tests') {
        //     steps {
        //         dir('frontend') {
        //             sh 'docker run --rm -v $PWD:/app -w /app node:18 sh -c "npm install && npm test"'
        //         }
        //     }
        // }

        stage('4. Build Frontend') {
            steps {
                dir('frontend') {
                    sh 'docker run --rm -v $PWD:/app -w /app node:18 sh -c "npm install && npm run build"'
                }
            }
        }

        stage('5. Docker Build') {
            steps {
                script {
                    def backend_services = ['alert-engine', 'auth-service', 'summarizer-service', 'vitals-generator']
                    backend_services.each { service ->
                        dir("backend/${service}") {
                            sh "docker build -t ${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${service}:${APP_VERSION} ."
                        }
                    }
                    dir("frontend") {
                        sh "docker build -t ${DOCKER_REGISTRY}/${DOCKER_USERNAME}/frontend:${APP_VERSION} ."
                    }
                }
            }
        }

        stage('6. Docker Push') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: DOCKER_CREDENTIALS_ID, usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh "echo ${DOCKER_PASS} | docker login ${DOCKER_REGISTRY} -u ${DOCKER_USER} --password-stdin"
                        
                        def services_to_push = ['alert-engine', 'auth-service', 'vitals-generator']
                        
                        services_to_push.each { service ->
                            def imageName = "${DOCKER_REGISTRY}/${DOCKER_USERNAME}/${service}:${APP_VERSION}"
                            sh "docker push ${imageName}"
                        }

                        def frontendImageName = "${DOCKER_REGISTRY}/${DOCKER_USERNAME}/frontend:${APP_VERSION}"
                        sh "docker push ${frontendImageName}"
                    }
                }
            }
        }

        stage('7. Local Agent Cleanup') {
            steps {
                script {
                    sh 'chmod +x cleanup.sh'
                    sh './cleanup.sh ${DOCKER_USERNAME} ${APP_VERSION}'
                }
            }
        }

        stage('8. Docker Compose Integration Test') {
            steps {
                script {
                    try {
                        echo "Starting services for integration test..."
                        sh 'docker-compose -f docker-compose.yml up -d'
                        
                        echo "Waiting for services to stabilize..."
                        sh 'sleep 10'

                        echo "Running deployment tests..."
                        sh 'chmod +x test-deployment.sh'
                        sh './test-deployment.sh'
                    } finally {
                        echo "Tearing down integration test environment..."
                        sh 'docker-compose -f docker-compose.yml down --remove-orphans'
                    }
                }
            }
        }

        stage('9. Deployment (Ansible)') {
            steps {
                dir('infrastructure/ansible') {
                    script {
                        def ansibleRunnerImage = "ansible-runner:${APP_VERSION}"
                        
                        // Build the ansible runner image from the Dockerfile
                        sh "docker build -t ${ansibleRunnerImage} ."

                        // Run the playbook inside the container for local deployment.
                        // We mount the user's .kube directory to give kubectl inside the container access to the host's k8s cluster.
                        // We pass environment variables for Ansible to use in templates.
                        sh """
                            docker run --rm --network="host" \
                                -v ~/.kube:/root/.kube:ro \
                                -v ${WORKSPACE}:/workspace \
                                -w /workspace/infrastructure/ansible \
                                -e DOCKER_REGISTRY="${DOCKER_REGISTRY}" \
                                -e DOCKER_USERNAME="${DOCKER_USERNAME}" \
                                -e APP_VERSION="${APP_VERSION}" \
                                ${ansibleRunnerImage} \
                                ansible-playbook -i inventory/hosts playbooks/backend.yml
                        """
                    }
                }
            }
        }
        
        stage('9. Post-Deployment Validation') {
            steps {
                echo "Skipping post-deployment validation for now."
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished.'
            cleanWs()
        }
        success {
            mail to: 'your-email@example.com',
                 subject: "SUCCESS: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                 body: "Pipeline finished successfully. Details: ${env.BUILD_URL}"
        }
        failure {
            mail to: 'your-email@example.com',
                 subject: "FAILURE: ${env.JOB_NAME} - Build #${env.BUILD_NUMBER}",
                 body: "Pipeline failed. Details: ${env.BUILD_URL}"
        }
    }
}
